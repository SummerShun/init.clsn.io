#!bin/bash
# update: 20230309
# desc: init new machine 


### 
### Available switches:
###  -n - define hostname
###  -z - Whether to install zerotier (default y)
### 

#hostname=$(hostname)
#pubip=$(curl -s ip.me)
log_file="/tmp/init_h.log"

function logs(){
    logtime=$(date +"%F %T")
    if [ $1 -eq 0 ];then
        echo  "[$logtime] INFO $2" | tee -a ${log_file}
    else
        echo  "[$logtime] ERROR $2"  | tee -a ${log_file}
    fi
}

# add user
function user_mode(){
    timedatectl set-timezone Asia/Shanghai 2>/dev/null
    useradd houzhaoshun >${log_file} 2>&1
    logs $? "Add user"
    echo '%houzhaoshun    ALL=(ALL)       NOPASSWD: ALL' >> /etc/sudoers
    mkdir  -p /home/houzhaoshun/.ssh/
cat >> /home/houzhaoshun/.ssh/authorized_keys <<EOF
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCw5w7GqqRDWtRvleuYORIEPicbKWR1oMxxHpmYRYMz6/1ery4PB+tCyoaAWz8DNMs+yXbJb4WhzK7kATY7YesX8EIUKdikih09vHbnIOVyACaFKkLzeo0efJVlGYFQDIG42Us4wtgR2iaZtayp/xGux51xOlh6rlvXhXfnE8jla62C/HWba5SlcJsfTQcfWkeXrCxbzRrDrmbohJ9ORlB3iHn889dwPHZML6BTsmdKQMp9Jzge5eMaxXVwfUB+6OI31H/2v0/3409DhecR4O5J9UjB3muh2MRx3vkRctHCcB2YX7Gzwo4wzClzL50Xlk/xkaLqIblLfuPINpZFL6fl houzhaoshun@nginx.ddns.clsn.io
EOF
    chown -R houzhaoshun.houzhaoshun  /home/houzhaoshun/.ssh
    chmod 600 /home/houzhaoshun/.ssh/authorized_keys
    chmod 700 /home/houzhaoshun/.ssh
    logs $? "Add Authorized Keys"
}

# add priv network
function zerotier(){
    logs 0 "Start Install Zerotier"
    tmpf="/tmp/`uuidgen`.sh"
    curl -s https://install.zerotier.com > ${tmpf}
    sudo bash ${tmpf} >> ${log_file}
    logs $? "install zerotier"
    rm -f ${tmpf}
    zerotier-cli join a0cbf4b62a57f410 &>> ${log_file}
    logs $? "join zerotier"
    logs 0 "`zerotier-cli  info`"
}

function modify_hostname(){
    nh="$1.inner.clsn.io"
    h1=$(hostname)
    hostnamectl set-hostname $nh
    logs $? "modify hostname $h1 to $nh"
    cp -f /etc/resolv.conf{,.bak.`date +%s`}
cat > /etc/resolv.conf <<EOF
# Generated by hou ini scripts
search inner.clsn.io 
nameserver 10.0.0.252
nameserver 8.8.8.8
nameserver 1.1.1.1 
EOF
    logs $? "modify resolv"
    
}

function main(){
  modify_hostname $1 
  user_mode
  if [ $2 == "y" ];then
      zerotier
  fi
}
function _help(){
    echo -e "eg: \n/bin/sh $0 -n [hostname] -z [y/n]"
    sed -rn 's/^### ?//;T;p;' "$0"
    exit 1
}

if [ $# -eq 0 ];then _help ;fi
install_zero="y"
while getopts ":n:z:h" optname
do
  case "$optname" in
    "n")
      new_name=$OPTARG
      ;;
    "z")
      install_zero=$OPTARG
      ;;
    *|"?"|"h"|":"|"-")
      _help
      ;;
  esac
done
[ -z $new_name ] && _help
# echo "$new_name $install_zero"
main $new_name $install_zero
